<script src="js/socket.io.dev.js"></script>
<script src="js/jquery-3.4.1.min.js"></script>

<script>
    function getJsonFromUrl(url) {
        if(!url) url = location.search;
        var query = url.substr(1);
        var result = {};
        query.split("&").forEach(function(part) {
            var item = part.split("=");
            result[item[0]] = decodeURIComponent(item[1]);
        });
        return result;
    }

    const renderWaitingRoom = waitingRoom => {
        $("#waitingRoom").html("");
        $.each(waitingRoom, (index, client) => {
            $("#waitingRoom").append('<p>' + client + '</p>');
        });
    };

    $( document ).ready(function() {
        var params = getJsonFromUrl();
        var email = params.email;
        var password = params.password;

        if(!email || !password) {
            $('#invalidParams').show();
            return ;
        }

        $("#email").html(email);
        $.post(
            '/authentication/store', // url
            { email, password }, // params
            (response, textStatus, request) => { // callback
                const storeId = response.data.storeId;

                var socket = io(
                    '?storeId='+ storeId,
                    {
                        path: '/waiting-room-socket'
                    }
                );

                socket.on('disconnect', function(){
                    $("#socketStatus").html("<span style='color: darkred'>disconnected</span>")
                });

                socket.on('connect', function(){
                    $("#socketStatus").html("<span style='color: green'>connected</span>")
                });

                socket.on('WAITING_ROOM_SENDED', function(waitingRoom){
                    console.log(waitingRoom);
                    console.log('WAITING_ROOM_SENDED',  waitingRoom);
                    renderWaitingRoom(waitingRoom);
                });

                socket.on('WAITING_ROOM_CHANGED', function(waitingRoom){
                    console.log('WAITING_ROOM_CHANGED', waitingRoom);
                    renderWaitingRoom(waitingRoom);
                });
            }
        ).fail(function(response) {
            alert( response.statusText );
        });

    });
</script>
<html>
    <body>
        <div style="display: none;" id="invalidParams">
            <h1 style="color: darkred">Error - Required uri: ?email=alemmartin@gmail.com&password=sonserios</h1>
        </div>

        <h1>Tienda ID: <span id="storeId"></span></h1>
        <h1>Socket STATUS: <span id="socketStatus"></span></h1>

        <h2>User Email</h2>
        <p id="email"></p>

        <h1>COLA</h1>
        <p><span id="waitingRoom"></span></p>
    </body>
</html>