<script src="js/socket.io.dev.js"></script>
<script src="js/jquery-3.4.1.min.js"></script>

<script>
    function getJsonFromUrl(url) {
        if(!url) url = location.search;
        var query = url.substr(1);
        var result = {};
        query.split("&").forEach(function(part) {
            var item = part.split("=");
            result[item[0]] = decodeURIComponent(item[1]);
        });
        return result;
    }

    $( document ).ready(function() {
        $('#storeId').html(storeId);
        $('#clientName').html(name + ' ' + lastName);
    });

    const renderWaitingRoom = waitingRoom => {
        $("#waitingRoom").html("");
        $.each(waitingRoom, (index, client) => {
            $("#waitingRoom").append('<p>' + client + '</p>');
        });
    };

    var params = getJsonFromUrl();

    var storeId = params.storeId;
    var email = params.email;
    var name = params.name;
    var lastName = params.lastName;

    $.post(
        '/waiting-room/' + storeId, // url
        { email, name, lastName }, // params
        () => { // callback
            var socket = io('?clientId='+ name +'&storeId=' + storeId, { path: '/waiting-room-socket' });

            socket.on('WAITING_ROOM_CHANGED', function(waitingRoom){
                console.log('WAITING_ROOM_CHANGED', waitingRoom);
                renderWaitingRoom(waitingRoom);
            });

            socket.on('WAITING_ROOM_SENDED', function(waitingRoom){
                console.log(waitingRoom);
                console.log('WAITING_ROOM_SENDED',  waitingRoom);
                renderWaitingRoom(waitingRoom);
            });
        }
    );
</script>
<html>
    <body>
        <h1>Tienda ID: <span id="storeId"></span></h1>
        <h2>Cliente: <span id="clientName"></span></h2>
        <p><span id="waitingRoom"></span></p>
    </body>
</html>